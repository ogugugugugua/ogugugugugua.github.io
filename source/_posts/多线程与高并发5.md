---
title: 多线程与高并发5
tags:
  - JavaSE
  - 多线程
  - ThreadLocal
  - Java引用
categories: 多线程
abbrlink: 4760c7e8
date: 2020-09-19 12:05:10
---
摘要：ThreadLocal，Java引用类型

<!-- more -->

## varHandle

可以用于获取某个对象的引用，其具有两个有意思的特点：

1. 可以对普通属性进行原子操作。
2. 比反射快，直接操纵二进制码

---

## ThreadLocal类

允许我们创建只能被同一个线程读写的变量。因此，如果一段代码含有一个ThreadLocal变量的引用，即使两个线程同时执行这段代码，它们也无法访问到对方的ThreadLocal变量。

数据库声明式事务可以用到，以保证多个事务用到的是同一个连接：在单线程应用程序中可能会维持一个全局的数据库连接，并在程序启动时初始化这个连接对象，从而避免在调用每个方法时都要传递一个Connection对象。由于JDBC的连接对象不一定是线程安全的，因此在多线程应用程序在没有协同的情况下使用全局变量时，就不是线程安全的。通过将JDBC的连接保存到ThreadLocal对象中，每个线程都会拥有属于自己的连接：

```java 
private static ThreadLocal<Connection> connectionHolder = new ThreadLocal<Connection>(){
    @Override
    public Connection initialValue(){
        return DriverManager.getConnection(DB_URL);
    }
};

public static Connection getConnection(){
    return connectionHolder.get();
}
```

当某个线程首次调用ThreadLocal.get方法时，就会调用initialValue来获取初始值。

从概念上看，可以将ThreadLocal<T> 看成包含了Map<Thread, T>对象，其中保存了特定于该线程的值。

如果需要将一个单线程应用程序移植到多线程环境中，通过将共享的全局变量转换为ThreadLocal对象，可以维持线程安全性。

---

## Java的四种引用：

强软弱虚

1. 普通的引用就是强引用。被强引用的对象显然不会被GC回收

2. 软引用SoftReference。当一个内存被软引用指向，只有当空间不够用的时候才会被回收。用途：可以用在缓存，比如缓存一个大图片。

3. 弱引用WeakReference。只要遇到GC就会被回收。一般用在容器里。如WeakHashMap。一个典型的应用就是ThreadLocal。

4. 虚引用PhantomReference管理堆外内存。

